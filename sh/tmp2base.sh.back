#!/bin/bash

DT=$1

user="root"



MYSQL_PWD='qwer1234' mysql --local-infile=1 -u"$user" <<EOF
DELETE FROM history_db.cmd_usage WHERE dt= '${DT}';

INSERT INTO history_db.cmd_usage
SELECT 
	case when dt like '%-%-%' 
		then str_to_date(dt, '%Y-%m-%d'),
		else str_to_date('1970-01-01', '%Y-%m-%d')
	end as dt,
	command,
	case when cnt regexp '[0-9]+$',
		then cast(cnt as unsigned)
		else -1
	end as cnt,
	'${DT}'AS tmp_dt
from history_db.tmp_cmd_usage
where dt = '${DT}'
EOF

echo "DONE"
